# Snakemake rules to generate and
# process reference sequence data
#
# Author: Maurits Evers
# License: GPLv3
# Original date: 13-02-2016
# Last changed: 22-02-2017


# Function to calculate the total genome size
# based on a reference sequence summary text file
#def get_fasta_size(input):
#    import csv
#    cr = csv.reader(open(input.refSum, "rt"))
#    N = sum(int(x[1]) for x in cr))
#    return(int(N))


localrules:
    download_reference


# Rule to download reference sequence using curl
rule download_reference:
    input:
    output:
        join(config["refdir"], "{version}", "{chr}.fa.gz")
    params:
        cmd  = "curl",
        URL  = lambda wildcards: expand("{url}", url = config["reference"][wildcards.version][wildcards.chr])
    version: "1.0"
    shell:
        """
            {params.cmd} -o {output} {params.URL}
        """


# Rule to estimate the size of reference files
# Input is a directory containing fa/fa.gz files
# Output is csv file in the same folder
rule estimate_ref_size:
    input:
        join(config["refdir"], "{version}")
    output:
        join(config["refdir"], "{version}/ref_index.csv")
    log:
        "logs/estimate_ref_size_{version}.log"
    params:
        cmd = "Rscript scripts/get_fasta_size.R"
    version: "1.0"
    shell:
        """
            {params.cmd} \
            -d {input} \
            -o {output} &> {log}
        """
