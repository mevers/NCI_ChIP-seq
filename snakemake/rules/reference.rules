# Snakemake rules to generate and
# process reference sequence data
#
# Authors: Maurits Evers, Sebastian Kurscheid
# License: GPLv3
# Original date: 13-02-2016, ME
# Last changed: 05-04-2017, SK

localrules:
    download_reference

# Download reference sequence using curl
rule download_reference:
    input:
    output:
        join(config["refdir"], "{version}", "{chr}.fa.gz")
    params:
        cmd  = "curl",
        URL  = lambda wildcards: expand("{url}", url = config["reference"][wildcards.version][wildcards.chr])
    version: "1.0"
    shell:
        """
            {params.cmd} -o {output} {params.URL}
        """

# build bowtie2 index from downloaded FASTA
rule decompress_reference:
    version: "1.0"
    input:
        FASTAs = rules.download_reference.output
    output:
        "{refdir}/{version}/{chr}.fa"
    params:
        cmd = "gzip"
    shell:
        """
            {params.cmd} -dc {input.FASTAs} > {output}
        """

rule bowtie2_build_index:
    version: "1.0"
    input:
    output:
        "{indexdir}{index}.1.bt2"
    params:
        cmd = config["bowtie2-build"]["cmd"],
        FASTAs = lambda wildcards: ",".join(glob.glob("".join((config["refdir"], wildcards["index"], "/*.fa"))))
    log:
        "logs/bowtie2_build_index_{index}.log"
    shell:
        """
            {params.cmd} {params.FASTAs} {wildcards.indexdir}{wildcards.index}
        """
