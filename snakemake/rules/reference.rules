# Snakemake rules to generate and
# process reference sequence data
#
# Authors: Maurits Evers, Sebastian Kurscheid
# License: GPLv3
# Original date: 13-02-2016
# Last changed: 16-03-2017

localrules:
    download_reference

# Download reference sequence using curl
rule download_reference:
    input:
    output:
        join(config["refdir"], "{version}", "{chr}.fa.gz")
    params:
        cmd  = "curl",
        URL  = lambda wildcards: expand("{url}", url = config["reference"][wildcards.version][wildcards.chr])
    version: "1.0"
    shell:
        """
            {params.cmd} -o {output} {params.URL}
        """

# build bowtie2 index from downloaded FASTA
rule decompress_reference:
    version: "1.0"
    input:
        FASTAs = rules.download_reference.output
    output:
        join(config["refdir"], "{version}", "{chr}.fa")
    params:
        cmd = "gzip"
    shell:
        """
            {params.cmd} -d {input.FASTAs} {output}
        """

rule bowtie2_build_index:
    version: "1.0"
    input:
        FASTAs = lambda wildcards: re.sub(".gz", "", "/".join((config["refdir"], wildcards["index"], "*.fa")))
    output:
        join(config["indexdir"], "{index}")
    params:
        cmd = config["bowtie2-build"]["cmd"]
    log:
        "logs/bowtie2_build_index_{version}.log"
    shell:
        """
            {params.cmd} {input.FASTAs} {output}
        """
